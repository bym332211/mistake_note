# mistake_note · TODO 清单（MVP 优先 · 小步快跑）

> 说明：以下任务均采用 **checkbox** 清单格式，包含【目标 | 步骤 | DoD】。  
> 原则：**图片上传优先、摄像头可选**；**纯 CPU 可跑**；**先打通最小闭环**。

---

## 1. 项目骨架与启动脚手架（Day 0）【已完成】

**目标**  
- `git clone` 后 10 分钟内在 **纯 CPU** 启动最小 UI（无摄像头权限弹窗）。

**步骤**  
- [x] 初始化目录结构：`/app`(backend) `/ui`(gradio) `/data` `/media` `/scripts`。  
- [x] 提交 `requirements.txt`、`README.md`、`.env.example`（BAIDU_OCR/ASR/TTS、LLM KEY）。  
- [x] 启动命令：`python app.py` 或 `make dev`；启动自检缺失 KEY。  
- [x] `.gitignore`、日志打码，避免秘钥泄露。

**DoD**  
- 打开首页成功；缺 KEY 有清晰提示且不中断；日志不出现明文秘钥。

---

## 2. 图片上传功能（MVP）【未开始】

**目标**  
- 支持上传图片文件进行OCR识别，作为摄像头功能的替代方案。

**步骤**  
- [ ] 前端添加图片上传组件（支持常见格式：JPG/PNG/PDF）。  
- [ ] 后端接收图片文件并保存到 `/media/uploads` 目录。  
- [ ] 图片预览与确认机制。  
- [ ] 上传状态提示与错误处理。

**DoD**  
- 成功上传图片并显示预览；支持常见格式；错误处理友好。

---

## 3. 图像预处理（基础版）（MVP）【未开始】

**目标**  
- 提升 OCR 成功率与可读性。

**步骤**  
- [ ] 灰度化 + 自适应阈值 + 轻度去噪/增强。  
- [ ] 透视矫正（最大四边形）与简单去阴影。  
- [ ] 预处理快照回显，便于家长确认质量。

**DoD**  
- 与原始帧对比，OCR 文本完整度明显提升；失败率下降。

---

## 4. 接入百度 OCR（手写优先，回退通用）（MVP）【未开始】

**目标**  
- 稳定返回题干文本（手写/公式/通用）。

**步骤**  
- [ ] 集成 `handwriting` → 失败回退 `formula`/`general`。  
- [ ] 超时重试 + 退避策略；错误提示不阻塞 UI。  
- [ ] 关键参数（超时/重试/模式顺序）可配置。

**DoD**  
- 连续 20 次调用成功率 ≥ 95%；异常可见且不影响交互。

---

## 5. 最小引导（模板 → LLM）（MVP）【未开始】

**目标**  
- 给出**不直答**的"提问式"下一步提示（先模板后 LLM）。

**步骤**  
- [ ] 规则模板：按关键词（方程/几何/分数…）生成 1–2 条引导问句。  
- [ ] 接入 LLM（小上下文），系统提示强制"不直答"。  
- [ ] 配置"仅模板/模板+LLM"开关。

**DoD**  
- 任意 OCR 文本均可输出引导问句；人工抽检无"直接给答案"用语。

---

## 6. 错题卡数据模型与入库（SQLite + 媒体）（MVP）【未开始】

**目标**  
- 单次识别→结构化"错题卡"持久化。

**步骤**  
- [ ] 定义 JSON 字段（题干/步骤/错因/媒体 URL/向量…）。  
- [ ] 保存原图/预处理图到 `/media`；路径写入 DB（SQLite）。  
- [ ] UI 按钮「保存入库」与保存成功提示。

**DoD**  
- DB 可查到记录；媒体文件存在且可预览；重复保存具备哈希去重。

---

## 7. 基础相似题检索（仅 q_text_emb）（MVP）【未开始】

**目标**  
- 最短路径完成 RAG：按题干相似检索。

**步骤**  
- [ ] CPU 生成向量（`bge-m3`）；Chroma(HNSW) 建集合。  
- [ ] 提供 `/search/similar?text=` 接口与前端展示。  
- [ ] 简单 Top-K 返回，含题干与来源。

**DoD**  
- 有数据时能返回 ≥3 条相似记录；平均延迟 < 1.5s（不含网络）。

---

## 8. 一键 Demo 流（串联）（MVP 封板项）【未开始】

**目标**  
- 串起"上传图片 → OCR → 引导 → 入库 → 相似检索"。

**步骤**  
- [ ] 前端提供"试一题"流程引导与状态 Toast。  
- [ ] 全链路错误兜底与可重试。  
- [ ] Demo 日志（步骤级）可导出。

**DoD**  
- 现场演示成功率 ≥ 90%；失败时能快速定位到环节并重试。

---

## 9. 摄像头「按需开启」与权限管理（M2）【未开始】

**目标**  
- 默认关闭摄像头；**仅在学生点击后**开始视频流；可随时关闭。

**步骤**  
- [ ] 前端按钮「开启摄像头识别」→ 浏览器权限申请（WebRTC）。  
- [ ] 状态切换（开启/关闭/拒绝）与 Toast 提示。  
- [ ] 关闭后立即停止采集与上行，释放资源。  
- [ ] 记录开启/关闭时间戳与原因到日志。

**DoD**  
- 权限拒绝不崩溃；关闭后 CPU/网络占用明显下降；日志可复盘每次开关。

---

## 10. 抽帧与去重（CPU/成本友好）（M2）【未开始】

**目标**  
- 控制调用成本与时延：≤ 1 帧 / 1–2 秒，近似帧跳过 OCR。

**步骤**  
- [ ] 限制输入分辨率（最长边 ≤ 720px）。  
- [ ] 基于 `imagehash` 的感知哈希；设置相似阈值与可配间隔。  
- [ ] UI 回显"节流/跳过重复帧"状态。

**DoD**  
- OCR QPS ≤ 0.7；CPU 占用平稳；近似静止画面时基本不触发 OCR。

---

## 11. 语音识别（百度 ATR/ASR）（M2）【未开始】

**目标**  
- 学生口述思路转文本并合并入"学生步骤"。

**步骤**  
- [ ] 录音控件（按住说话/点击开始）；静音/超时检测。  
- [ ] `/voice/asr` 调用百度 ATR；失败重试与提示。  
- [ ] 将转写文本写入错题卡 `voice_transcript` 并汇总入 `student_solution_text`。

**DoD**  
- 中短句识别主观可用；合并后步骤更完整；失败场景 UI 友好。

---

## 12. 语音合成（百度 TTS）（M2）【未开始】

**目标**  
- 将引导建议播报为音频（可开关）。

**步骤**  
- [ ] `/voice/tts` 接口；中英切换、语速调节。  
- [ ] 前端音频播放器；"静音/文字/文字+语音"模式。  

**DoD**  
- 点击「播报」可听到当前建议；静音模式无外呼。

---

## 13. 学生步骤提炼与规范化（M2）【未开始】

**目标**  
- 融合 OCR + ASR，将解题过程规整为 2–4 步关键步骤。

**步骤**  
- [ ] 正则/模板初步抽取；  
- [ ] LLM 小上下文归纳为清晰步骤链。  
- [ ] 步骤链回显与编辑（可选）。

**DoD**  
- 多表述能归并；可读性通过人工检查；保存回错题卡。

---

## 14. 错因归因（规则 + LLM）（M2）【未开始】

**目标**  
- 输出主错因、次因、漏洞描述、建议（受控分类）。

**步骤**  
- [ ] 轻量规则校验（等式/单位/通分/符号）。  
- [ ] LLM 结构化输出（JSON Schema）。  
- [ ] 主错因必须从预置集合中选择。

**DoD**  
- 随机 30 条样本，主错因准确率 ≥ 70%；输出四要素完整。

---

## 15. 多视角向量与过滤（sol/concept）（M2）【未开始】

**目标**  
- 增强检索：解法向量与知识点向量；支持过滤。

**步骤**  
- [ ] 生成 `sol_text_emb`、`concept_emb`；写入索引。  
- [ ] 检索接口支持年级/学科/难度/时间过滤；可选重排。  

**DoD**  
- Top-5 召回较仅题干明显提升（离线对比）；过滤维度可用。

---

## 16. 学习单导出（Markdown→PDF）（M2）【未开始】

**目标**  
- 一键生成可打印学习单（概念要点/常见坑/相似题/同错因/行动清单）。

**步骤**  
- [ ] 模板渲染；导出至 `/media/exports`。  
- [ ] 前端下载按钮与文件管理。

**DoD**  
- 成功生成 PDF/MD；内容字段齐全；可复用打印。

---

## 17. 隐私同意与数据管理（M3）【未开始】

**目标**  
- 会话明确同意；摄像头默认关闭；一键清除/导出本地数据。

**步骤**  
- [ ] 首次弹窗与设置页说明；同意日志。  
- [ ] 清除/导出按钮；脱敏选项（可选人脸/PII 模糊）。  

**DoD**  
- 日志证明每次开启由学生主动触发；清除后 DB/媒体无残留。

---

## 18. ROI 选框与成本控制（M3）【未开始】

**目标**  
- 仅 OCR 题目区域，降低调用与延迟。

**步骤**  
- [ ] 前端框选 ROI；后端裁剪后再预处理/OCR。  
- [ ] 统计 OCR 次数与延迟。

**DoD**  
- 平均 OCR 次数/延迟下降 ≥ 30%；识别质量不下降。

---

## 19. 缓存与去重监控（M3）【未开始】

**目标**  
- 提高近重复命中，稳定尾延迟。

**步骤**  
- [ ] 帧哈希 + 文本哈希两级缓存。  
- [ ] UI 展示命中率；指标上报（本地统计）。

**DoD**  
- 近重复命中率 ≥ 40%；尾延迟波动降低。

---

## 20. 评估脚本与基准（M3）【未开始】

**目标**  
- 可复现离线评测（检索与归因）。

**步骤**  
- [ ] 构造标注集（相似/非相似、同错因/不同错因）。  
- [ ] 计算 Recall@k、nDCG@k；归因人工抽检表。  
- [ ] 成本/时延报表脚本。

**DoD**  
- 一键生成评估报告；达到门槛：R@5≥0.6、归因≥70%。

---

## 21. CPU 性能压测与降级策略（M3）【未开始】

**目标**  
- 4 核笔记本流畅演示，网络抖动下可用。

**步骤**  
- [ ] 限流/批处理/小上下文；必要时仅文字模式 fallback。  
- [ ] 压测脚本：并发、长时间运行、API 抖动。

**DoD**  
- p95 引导生成 ≤ 3s（不含外部网络时延）；异常自动降级仍可交互。

---
