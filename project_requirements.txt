# requirements.txt — 产品与工程需求（文本规范，含语音与“摄像头按需开启”改动）

PROJECT
- 名称：mistake_note
- 一句话：基于摄像头（按需开启）+ 百度 OCR + 百度语音识别(ASR/ATR) + 百度语音合成(TTS) + LLM + RAG，
  为学生提供“提问式、分步引导”的作业辅导，并沉淀个人化错题知识库；全链路可在 CPU 上运行。

SCOPE（MVP 范围）
- 浏览器端摄像头 **仅在学生明确点击开启后** 才开始视频流（默认关闭，随时一键关闭）。
- 实时采集（抽帧/限流），CPU 环境可运行（推理/向量/后处理均支持无 GPU）。
- 百度 OCR（手写/公式/通用）+ 预处理（矫正/去噪/二值化）。
- **百度 ATR（ASR）语音识别**：学生可通过麦克风口述思路，转文本纳入解题步骤。
- **百度 TTS 语音合成**：将引导建议合成为语音回放（可选开关）。
- LLM “苏格拉底式”引导（不直答）。
- 错题卡入库（结构化 JSON + 图片/音频引用）。
- RAG 检索：相似题/同错因/按知识点。
- 本地优先存储（SQLite + 本地文件目录/对象存储路径），可选云路径。
- **CPU 友好**：嵌入/RAG/服务调度在无 GPU 环境可用；若使用云端 LLM 也需支持本地降级策略。

OUT OF SCOPE（MVP 不做）
- 自动判分与整卷评测
- 教师/家长多租户与可视化看板（留待后续）
- 端侧离线 TTS/ASR（MVP 使用百度云 API）

FUNCTIONAL REQUIREMENTS（功能需求）
FR-001 设备权限与开关（新增“按需开启摄像头”）
  - 默认：摄像头关闭。仅在学生点击“开启摄像头识别”后，申请浏览器权限并开始推流。
  - UI 显示实时状态与“关闭摄像头”按钮；关闭后立即停止采集与上行。
  - 记录开关时间戳与原因（开启/关闭/权限拒绝）。

FR-002 采集与节流（CPU 友好）
  - 采样：≤ 1 帧 / 1–2 秒（可配置），分辨率自适应（最长边 ≤ 720px）。
  - 感知哈希去重：近似帧跳过 OCR 调用。
  - ROI 选框：仅对 ROI 区域 OCR，降低延迟与费用。

FR-003 图像预处理
  - 透视矫正（最大四边形）、自适应阈值、去阴影；必要时锐化与对比度增强。
  - 处理后的快照展示在 UI，便于家长/学生确认。

FR-004 OCR（百度）
  - 模式优先级：手写 > 公式 > 通用（失败逐级回退）。
  - 返回文本、可用则带置信度/行框；失败重试与退避；本地 PaddleOCR 作为兜底（可选）。

FR-005 语音识别 ATR（百度 ASR）
  - 学生可按住说话或点击“开始录音”，将口述思路转文本，合并入“学生步骤”。
  - 噪声与静音检测；超时自动停止；失败提示与重试。
  - 文本与时间戳一并写入错题卡的“student_solution_text / voice_transcript”。

FR-006 语音合成 TTS（百度）
  - 将“引导建议/下一步提示”合成为音频回放（可选）；支持中英文切换与语速调节。
  - UI 提供“静音/仅文字/文字+语音”模式切换。

FR-007 学生步骤提取与规范化
  - 从 OCR 与语音转写融合“关键步骤”摘要，标准化表达（例：2x+3=11 → 2x=8 → x=4）。

FR-008 错因归因（混合）
  - 规则校验（等式运算/单位/分数等） + LLM 判定。
  - 输出：error_type[]、error_factors[]、reasoning_gaps[]、recommendations[]。
  - 主错因必须从受控分类集中选择。

FR-009 错题卡
  - 字段：id、时间、年级/学科、topic_tags、难度、question_text、
    student_solution_text、voice_transcript?、gold_solution_brief（不含完整答案）、
    错因字段、媒体 URL（原图/矫正/ROI/音频）、向量。
  - 媒体文件保存到本地目录/对象存储；路径可配置。

FR-010 向量与索引（CPU）
  - 生成 q_text_emb、sol_text_emb、concept_emb、（可选）error_emb。
  - 使用 sentence-transformers（bge-m3 等）CPU 推理；向量库 Chroma(HNSW)。
  - 元数据镜像到 SQLite；提供迁移脚本。

FR-011 检索 API
  - /search/similar?text=...
  - /search/same-error?desc=...
  - /search/by-concept?tags=...
  - 支持过滤（年级/学科/难度/时间），可选稀疏检索与轻量重排。

FR-012 引导生成（不直答）
  - 基于当前文本（OCR+语音转写）与检索上下文，生成“提问先行”的下一步提示与自检清单。
  - 安全规则：不输出最终数值/封闭解；必要时仅输出提示问题。

FR-013 学习单
  - 生成可打印 Markdown/PDF：概念要点、常见坑、3–5 相似题、2–3 同错因对照、行动清单。
  - 可选生成 TTS 音频总结（简短版）。

FR-014 UI 与可用性
  - 面板：摄像头（默认关闭）、处理快照、OCR 文本、语音输入区、引导建议、音频播放器（TTS）、按钮[保存][相似检索][同错因检索]。
  - Toast 显示：OCR/ATR/TTS 调用状态、节流/去重命中、错误信息。

NON-FUNCTIONAL REQUIREMENTS（非功能）
NFR-001 隐私与同意（新增）
  - 显式同意：首次使用与每次会话启动时弹窗说明采集范围；摄像头默认关闭，需手动开启。
  - 支持人脸/PII 模糊（可选）；本地优先存储；除调用百度 API 外不外传。
  - 提供“一键清除本地数据”与导出功能。

NFR-002 CPU 兼容与性能
  - **必须**在纯 CPU 环境可运行：OCR/ATR/TTS 为云 API；嵌入/RAG/服务端推理支持 CPU。
  - 目标：普通笔记本（4 核）下，引导生成 p95 ≤ 3s（不含外部 API 网络时延）。
  - 内存占用 ≤ 2GB（不含浏览器）。

NFR-003 可靠性与降级
  - OCR/ATR/TTS/LLM 任一失败时，给出明确提示并保持 UI 可用；可选择“仅文字模式/仅检索模式”。
  - 入库幂等：基于哈希去重；网络故障队列重试。

NFR-004 成本与配额
  - 抽帧 + ROI 控制 OCR 调用；语音识别最短计时与静音截断。
  - 缓存策略：近重复帧与近似文本命中率 ≥ 40%。

EVALUATION（评估）
  - 检索：Recall@5、nDCG@10。
  - 归因：人工抽检 ≥ 70% 准确率（100 样本）。
  - 可用性：学生/家长问卷（语音+文字提示的帮助度）。
  - 隐私：同意日志覆盖率 100%，摄像头按需开启合规。

ERROR TAXONOMY（错因分类 v1）
- 主类：概念不清、审题错误、计算错误、步骤/遗漏、策略不当、单位/格式、作图/标注、粗心、时间/规划
- 次级示例：移项后常数计算错误、通分分母选择错误、角度↔弧度混淆等

APIs（MVP）
- POST /ingest/mistake_card
- GET  /search/similar
- GET  /search/same-error
- GET  /search/by-concept
- POST /guidance（入参：ocr_text、voice_transcript?、student_steps?、retrieved_snippets?）
- POST /voice/asr  （上传音频，调用百度 ATR，返回文本）
- POST /voice/tts  （输入文本，调用百度 TTS，返回音频 URL）

TECH STACK（CPU 友好）
- 前端：Gradio（摄像头按需开启、麦克风、音频播放）
- OCR/ATR/TTS：百度智能云 API
- LLM：可插拔（云端优先；本地无 GPU 运行时走小上下文/工具化）
- Embedding & RAG：sentence-transformers（bge-m3，CPU）、Chroma(HNSW)
- 存储：SQLite + 本地媒体目录
- 语言：Python 3.10+

MILESTONES（里程碑）
M1（第 1 周）：摄像头按需开启→OCR→引导→错题卡入库（CPU）；语音识别与合成基础打通。
M2（第 2 周）：错因归因（规则+LLM）、多视角向量、三类检索、学习单导出、TTS 播报。
M3（第 3 周）：隐私同意与日志、缓存/去重优化、CPU 性能与成本压测、评估脚本与验收。

DEFINITION OF DONE（完成标准）
- 纯 CPU 环境无 GPU 可运行完整闭环。
- 有效错题卡 ≥ 50；检索 top-5 Recall ≥ 0.6；归因正确率 ≥ 70%。
- 100 次交互“禁止直答”零违规；摄像头均由学生主动开启且可被日志验证。
